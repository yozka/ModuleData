#include "DSRandomGenerator.h"
#include <QVariant>
#include <QTime>
#include <QDateTime>
///--------------------------------------------------------------------------------------



///--------------------------------------------------------------------------------------
using namespace DataSource;
///--------------------------------------------------------------------------------------





///--------------------------------------------------------------------------------------
int gNumber = 0;
///--------------------------------------------------------------------------------------







 ///=====================================================================================
///
/// Constructor
/// 
/// 
///--------------------------------------------------------------------------------------
ARandomGenerator :: ARandomGenerator ()
	:
	mInterval(settings::interval),
	mTimer(nullptr),
	mBeginMs(0)
{
	gNumber++;
	mNumber = gNumber;
}
///--------------------------------------------------------------------------------------







 ///=====================================================================================
///
/// Destructor
/// 
/// 
///--------------------------------------------------------------------------------------
ARandomGenerator :: ~ARandomGenerator ()
{
	close();
	delete mTimer;
}
///--------------------------------------------------------------------------------------










 ///=====================================================================================
///
/// возвратим имя источника данных
/// 
/// 
///--------------------------------------------------------------------------------------
QString ARandomGenerator :: title() const
{
	return "Random generator - " + QString::number(mNumber);
}
///--------------------------------------------------------------------------------------








 ///=====================================================================================
///
/// покажем диалог информации по источнику данных
/// 
/// 
///--------------------------------------------------------------------------------------
void ARandomGenerator :: show()
{

}
///--------------------------------------------------------------------------------------








 ///=====================================================================================
///
/// открытие данных
/// 
/// 
///--------------------------------------------------------------------------------------
void ARandomGenerator :: onOpen()
{
	if (mTimer == nullptr)
	{
		mTimer = new QTimer(this);
		connect(mTimer, &QTimer::timeout, this, &ARandomGenerator::update);
		
		qsrand(static_cast<uint>(QTime::currentTime().msec()));
	}

	mBeginMs = QDateTime::currentMSecsSinceEpoch();
	mTimer->start(mInterval);
}
///--------------------------------------------------------------------------------------








 ///=====================================================================================
///
/// закрытие данных
/// 
/// 
///--------------------------------------------------------------------------------------
void ARandomGenerator :: onClose()
{
	if (mTimer == nullptr)
	{
		return;
	}
	mTimer->stop();
}
///--------------------------------------------------------------------------------------








 ///=====================================================================================
///
/// обновление таймера
/// 
/// 
///--------------------------------------------------------------------------------------
void ARandomGenerator :: update()
{
	const int range = settings::max - settings::min;
	const int val = (qrand() % range) + settings::min;

	const int timeMs = QDateTime::currentMSecsSinceEpoch() - mBeginMs;

	QList<int> data;
	data.append(timeMs);
	data.append(val);
	streamData->command_dataSend(QVariant::fromValue<QList<int>>(data));
}


	